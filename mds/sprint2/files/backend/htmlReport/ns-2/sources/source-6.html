


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=GBK"> 
  <title>Coverage Report > MessageApp</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.example.backend.app</a>
</div>

<h1>Coverage Summary for Class: MessageApp (org.example.backend.app)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">MessageApp</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    27.3%
  </span>
  <span class="absValue">
    (3/11)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/30)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    16.7%
  </span>
  <span class="absValue">
    (16/96)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package org.example.backend.app;
&nbsp;
&nbsp;import org.example.backend.domain.AbstractUser;
&nbsp;import org.example.backend.domain.Message;
&nbsp;import org.example.backend.dto.AbstractUserDto;
&nbsp;import org.example.backend.dto.MessageDto;
&nbsp;import org.example.backend.service.AbstractUserService;
&nbsp;import org.example.backend.service.MessageService;
&nbsp;import org.example.backend.util.JwtUtil;
&nbsp;import org.example.backend.websocket.WebSocketServer;
&nbsp;import org.json.JSONObject;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.web.bind.annotation.*;
&nbsp;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.time.format.DateTimeFormatter;
&nbsp;import java.util.*;
&nbsp;
&nbsp;/**
&nbsp; * 该类用于处理消息相关的请求
&nbsp; * @author Shinomiya
&nbsp; * @version 1.0
&nbsp; */
&nbsp;@RestController
&nbsp;@RequestMapping(&quot;/message&quot;)
<b class="fc">&nbsp;public class MessageApp {</b>
&nbsp;    @Autowired
&nbsp;    MessageService messageService;
&nbsp;    @Autowired
&nbsp;    AbstractUserService abstractUserService;
&nbsp;
&nbsp;//    private String getSendMessage(User user) {
&nbsp;//        JSONObject jsonObject = new JSONObject();
&nbsp;//        jsonObject.put(&quot;userId&quot;, user.getId());
&nbsp;//        jsonObject.put(&quot;userName&quot;, user.getUsername());
&nbsp;//        return jsonObject.toString();
&nbsp;//    }
&nbsp;
&nbsp;
&nbsp;
&nbsp;    // This method is very stupid, but I don&#39;t know how to improve it.
&nbsp;//    private Response handleInvitationError(Message message, Student student, Student friend, String type) {
&nbsp;//        if (message == null) {
&nbsp;//            return new Response(false, 1, &quot;Message not found&quot;);
&nbsp;//        }
&nbsp;//        if (message.getTo().getId() != student.getId()) {
&nbsp;//            return new Response(false, 2, &quot;You are not the receiver&quot;);
&nbsp;//        }
&nbsp;//        if (!message.getType().equals(&quot;Invitation&quot;)) {
&nbsp;//            return new Response(false, 3, &quot;Message is not an invitation&quot;);
&nbsp;//        }
&nbsp;//        if (type.equals(&quot;Accept&quot;)) {
&nbsp;//            if (student.getProfile().getSex() != friend.getProfile().getSex()) {
&nbsp;//                return new Response(false, 4, &quot;Your sex are different&quot;);
&nbsp;//            }
&nbsp;//            if (student.getProfile().getType() != friend.getProfile().getType()) {
&nbsp;//                return new Response(false, 5, &quot;Your type are different&quot;);
&nbsp;//            }
&nbsp;//        }
&nbsp;//        return new Response(true, 0, &quot;success&quot;);
&nbsp;//    }
&nbsp;
&nbsp;//    private Response handleExchangeError(Message message, Student student, Student friend, String type) {
&nbsp;//        if (message == null) {
&nbsp;//            return new Response(false, 1, &quot;Message not found&quot;);
&nbsp;//        }
&nbsp;//        if (message.getTo().getId() != student.getId()) {
&nbsp;//            return new Response(false, 2, &quot;You are not the receiver&quot;);
&nbsp;//        }
&nbsp;//        if (!message.getType().equals(&quot;Exchange&quot;)) {
&nbsp;//            return new Response(false, 3, &quot;Message is not an exchange&quot;);
&nbsp;//        }
&nbsp;//        if (type.equals(&quot;Accept&quot;)) {
&nbsp;//            if (student.getProfile().getSex() != friend.getProfile().getSex()) {
&nbsp;//                return new Response(false, 4, &quot;Your sex are different&quot;);
&nbsp;//            }
&nbsp;//            if (student.getProfile().getType() != friend.getProfile().getType()) {
&nbsp;//                return new Response(false, 5, &quot;Your type are different&quot;);
&nbsp;//            }
&nbsp;//        }
&nbsp;//        return new Response(true, 0, &quot;success&quot;);
&nbsp;//    }
&nbsp;
&nbsp;//    @GetMapping(&quot;/invAndApp&quot;)
&nbsp;//    public List&lt;Message&gt; getInvitations(@RequestHeader(&quot;Authorization&quot;) String token) {
&nbsp;//        long userId = JwtUtil.getIdByToken(token);
&nbsp;//        return messageService.findMessageByToIdAndType(userId, &quot;Invitation&quot;);
&nbsp;//    }
&nbsp;
&nbsp;    private String getSendMessage(AbstractUser user) {
<b class="fc">&nbsp;        JSONObject jsonObject = new JSONObject();</b>
<b class="fc">&nbsp;        jsonObject.put(&quot;userId&quot;, user.getId());</b>
<b class="fc">&nbsp;        jsonObject.put(&quot;userName&quot;, user.getUsername());</b>
<b class="fc">&nbsp;        return jsonObject.toString();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 获取通知
&nbsp;     * @param token 用户token
&nbsp;     * @return 通知列表
&nbsp;     */
&nbsp;    @GetMapping(&quot;/notice&quot;)
&nbsp;    public List&lt;Message&gt; getNotices(@RequestHeader(&quot;Authorization&quot;) String token) {
<b class="nc">&nbsp;        long userId = JwtUtil.getIdByToken(token);</b>
<b class="nc">&nbsp;        return messageService.findMessageByToUserIdAndType(userId, &quot;Notice&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 获取评论
&nbsp;     * @param token 用户token
&nbsp;     * @return 评论列表
&nbsp;     */
&nbsp;    @GetMapping(&quot;/chat&quot;)
&nbsp;    public List&lt;String&gt; getChatMessages(@RequestHeader(&quot;Authorization&quot;) String token) {
<b class="nc">&nbsp;        long userId = JwtUtil.getIdByToken(token);</b>
<b class="nc">&nbsp;        List&lt;Message&gt; fromMessages = messageService.findMessageByFromIdAndType(userId, &quot;Chat&quot;);</b>
<b class="nc">&nbsp;        List&lt;Message&gt; toMessages = messageService.findMessageByToUserIdAndType(userId, &quot;Chat&quot;);</b>
<b class="nc">&nbsp;        Map&lt;Long, Boolean&gt; map = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;        Set&lt;Long&gt; seen = new HashSet&lt;&gt;();</b>
<b class="nc">&nbsp;        List&lt;String&gt; result = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        for (Message message : toMessages) {</b>
<b class="nc">&nbsp;            if (map.containsKey(message.getFrom().getId())) {</b>
<b class="nc">&nbsp;                map.put(message.getFrom().getId(), map.get(message.getFrom().getId()) &amp;&amp; message.isRead());</b>
&nbsp;            } else {
<b class="nc">&nbsp;                map.put(message.getFrom().getId(), message.isRead());</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        for (Message message : fromMessages) {</b>
<b class="nc">&nbsp;            if (!map.containsKey(message.getToUser().getId())) {</b>
<b class="nc">&nbsp;                map.put(message.getToUser().getId(), true);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        for (Message message : fromMessages) {</b>
<b class="nc">&nbsp;            if (seen.contains(message.getToUser().getId())) {</b>
&nbsp;                continue;
&nbsp;            }
<b class="nc">&nbsp;            seen.add(message.getToUser().getId());</b>
<b class="nc">&nbsp;            JSONObject jsonObject = new JSONObject();</b>
<b class="nc">&nbsp;            jsonObject.put(&quot;userId&quot;, message.getToUser().getId());</b>
<b class="nc">&nbsp;            jsonObject.put(&quot;userName&quot;, message.getToUser().getName());</b>
<b class="nc">&nbsp;            jsonObject.put(&quot;hasUnread&quot;, !map.get(message.getToUser().getId()));</b>
<b class="nc">&nbsp;            result.add(jsonObject.toString());</b>
&nbsp;        }
<b class="nc">&nbsp;        for (Message message : toMessages) {</b>
<b class="nc">&nbsp;            if (seen.contains(message.getFrom().getId())) {</b>
&nbsp;                continue;
&nbsp;            }
<b class="nc">&nbsp;            seen.add(message.getFrom().getId());</b>
<b class="nc">&nbsp;            JSONObject jsonObject = new JSONObject();</b>
<b class="nc">&nbsp;            jsonObject.put(&quot;userId&quot;, message.getFrom().getId());</b>
<b class="nc">&nbsp;            jsonObject.put(&quot;userName&quot;, message.getFrom().getName());</b>
<b class="nc">&nbsp;            jsonObject.put(&quot;hasUnread&quot;, !map.get(message.getFrom().getId()));</b>
<b class="nc">&nbsp;            result.add(jsonObject.toString());</b>
&nbsp;        }
<b class="nc">&nbsp;        return result;</b>
&nbsp;    }
&nbsp;//    public List&lt;AbstractUserDto&gt; getChatMessages(@RequestParam(&quot;id&quot;) long userId) {
&nbsp;//        List&lt;Message&gt; fromMessages = messageService.findMessageByFromIdAndType(userId, &quot;Chat&quot;);
&nbsp;//        List&lt;Message&gt; toMessages = messageService.findMessageByToUserIdAndType(userId, &quot;Chat&quot;);
&nbsp;//        Map&lt;Long, Boolean&gt; map = new HashMap&lt;&gt;();
&nbsp;//        Set&lt;Long&gt; seen = new HashSet&lt;&gt;();
&nbsp;//        List&lt;AbstractUserDto&gt; result = new ArrayList&lt;&gt;();
&nbsp;//        for (Message message : toMessages) {
&nbsp;//            if (map.containsKey(message.getFrom().getId())) {
&nbsp;//                map.put(message.getFrom().getId(), map.get(message.getFrom().getId()) &amp;&amp; message.isRead());
&nbsp;//            } else {
&nbsp;//                map.put(message.getFrom().getId(), message.isRead());
&nbsp;//            }
&nbsp;//        }
&nbsp;//        for (Message message : fromMessages) {
&nbsp;//            if (!map.containsKey(message.getToUser().getId())) {
&nbsp;//                map.put(message.getToUser().getId(), true);
&nbsp;//            }
&nbsp;//        }
&nbsp;//        for (Message message : fromMessages) {
&nbsp;//            if (seen.contains(message.getToUser().getId())) {
&nbsp;//                continue;
&nbsp;//            }
&nbsp;//            seen.add(message.getToUser().getId());
&nbsp;//            AbstractUserDto abstractUserDto = new AbstractUserDto();
&nbsp;//            abstractUserDto.setId(message.getToUser().getId());
&nbsp;//            abstractUserDto.setName(message.getToUser().getName());
&nbsp;//            abstractUserDto.setHasUnread(!map.get(message.getToUser().getId()));
&nbsp;//            result.add(abstractUserDto);
&nbsp;//        }
&nbsp;//        for (Message message : toMessages) {
&nbsp;//            if (seen.contains(message.getFrom().getId())) {
&nbsp;//                continue;
&nbsp;//            }
&nbsp;//            seen.add(message.getFrom().getId());
&nbsp;//            AbstractUserDto abstractUserDto = new AbstractUserDto();
&nbsp;//            abstractUserDto.setId(message.getFrom().getId());
&nbsp;//            abstractUserDto.setName(message.getFrom().getName());
&nbsp;//            abstractUserDto.setHasUnread(!map.get(message.getFrom().getId()));
&nbsp;//            result.add(abstractUserDto);
&nbsp;//        }
&nbsp;//        return result;
&nbsp;//    }
&nbsp;
&nbsp;    /**
&nbsp;     * 获取聊天记录
&nbsp;     * @param token 用户token
&nbsp;     * @param friendId 好友id
&nbsp;     * @return 聊天记录
&nbsp;     */
&nbsp;    @GetMapping(&quot;/chatText&quot;)
&nbsp;    public List&lt;MessageDto&gt; getChatText(@RequestHeader(&quot;Authorization&quot;) String token, @RequestParam(&quot;userId&quot;) long friendId) {
<b class="nc">&nbsp;        long userId = JwtUtil.getIdByToken(token);</b>
<b class="nc">&nbsp;        List&lt;Message&gt; fromMessages = messageService.findMessageByFromIdAndToUserIdAndType(userId, friendId, &quot;Chat&quot;);</b>
<b class="nc">&nbsp;        List&lt;Message&gt; toMessages = messageService.findMessageByFromIdAndToUserIdAndType(friendId, userId, &quot;Chat&quot;);</b>
<b class="nc">&nbsp;        for (Message message : toMessages) {</b>
<b class="nc">&nbsp;            message.setRead(true);</b>
<b class="nc">&nbsp;            messageService.updateMessage(message);</b>
&nbsp;        }
<b class="nc">&nbsp;        fromMessages.addAll(toMessages);</b>
<b class="nc">&nbsp;        fromMessages.sort(Comparator.comparing(Message::getTime));</b>
<b class="nc">&nbsp;        return fromMessages.stream().map(this::constructMessageDto).toList();</b>
&nbsp;    }
&nbsp;//    public List&lt;Message&gt; getChatText(@RequestParam(&quot;id&quot;) long userId, @RequestParam(&quot;userId&quot;) long friendId) {
&nbsp;//        List&lt;Message&gt; fromMessages = messageService.findMessageByFromIdAndToUserIdAndType(userId, friendId, &quot;Chat&quot;);
&nbsp;//        List&lt;Message&gt; toMessages = messageService.findMessageByFromIdAndToUserIdAndType(friendId, userId, &quot;Chat&quot;);
&nbsp;//        for (Message message : toMessages) {
&nbsp;//            message.setRead(true);
&nbsp;//            messageService.updateMessage(message);
&nbsp;//        }
&nbsp;//        fromMessages.addAll(toMessages);
&nbsp;//        fromMessages.sort(Comparator.comparing(Message::getTime));
&nbsp;//        return fromMessages;
&nbsp;//    }
&nbsp;
&nbsp;    private MessageDto constructMessageDto(Message message) {
<b class="nc">&nbsp;        MessageDto messageDto = new MessageDto();</b>
<b class="nc">&nbsp;        messageDto.setId(message.getId());</b>
<b class="nc">&nbsp;        messageDto.setFrom(message.getFrom().getId());</b>
<b class="nc">&nbsp;        messageDto.setTo(message.getToUser().getId());</b>
<b class="nc">&nbsp;        messageDto.setFromName(message.getFrom().getName());</b>
<b class="nc">&nbsp;        messageDto.setToName(message.getToUser().getName());</b>
<b class="nc">&nbsp;        messageDto.setType(message.getType());</b>
<b class="nc">&nbsp;        messageDto.setContent(message.getContent());</b>
<b class="nc">&nbsp;        messageDto.setTime(String.valueOf(message.getTime()));</b>
<b class="nc">&nbsp;        messageDto.setRead(message.isRead());</b>
<b class="nc">&nbsp;        return messageDto;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * 发送聊天消息
&nbsp;     * @param token 用户token
&nbsp;     * @param friendId 好友id
&nbsp;     * @param content 消息内容
&nbsp;     * @param time 消息发送时间
&nbsp;     * @return 是否发送成功
&nbsp;     */
&nbsp;    @PostMapping(&quot;/sendChat&quot;)
&nbsp;    public boolean sendChat(@RequestHeader(&quot;Authorization&quot;) String token, @RequestParam(&quot;userId&quot;) long friendId, @RequestParam(&quot;content&quot;) String content, @RequestParam(&quot;time&quot;) String time) {
&nbsp;        try {
<b class="fc">&nbsp;            long userId = JwtUtil.getIdByToken(token);</b>
<b class="fc">&nbsp;            Message message = new Message();</b>
<b class="fc">&nbsp;            message.setFrom(abstractUserService.findUserById(userId));</b>
<b class="fc">&nbsp;            message.setToUser(abstractUserService.findUserById(friendId));</b>
<b class="fc">&nbsp;            message.setType(&quot;Chat&quot;);</b>
<b class="fc">&nbsp;            message.setContent(content);</b>
<b class="fc">&nbsp;            message.setTime(LocalDateTime.parse(time, DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;)));</b>
<b class="fc">&nbsp;            message.setRead(false);</b>
<b class="fc">&nbsp;            messageService.saveMessage(message);</b>
<b class="fc">&nbsp;            WebSocketServer.sendMessageToUser(friendId, getSendMessage(message.getFrom()));</b>
<b class="fc">&nbsp;            return true;</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;    }
&nbsp;//    public boolean sendChat(@RequestParam(&quot;id&quot;) long userId, @RequestParam(&quot;userId&quot;) long friendId, @RequestParam(&quot;content&quot;) String content, @RequestParam(&quot;time&quot;) String time) {
&nbsp;//        try {
&nbsp;//            Message message = new Message();
&nbsp;//            message.setFrom(abstractUserService.findUserById(userId));
&nbsp;//            message.setToUser(abstractUserService.findUserById(friendId));
&nbsp;//            message.setType(&quot;Chat&quot;);
&nbsp;//            message.setContent(content);
&nbsp;//            message.setTime(LocalDateTime.parse(time, DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;)));
&nbsp;//            message.setRead(false);
&nbsp;//            messageService.saveMessage(message);
&nbsp;//            WebSocketServer.sendMessageToUser(friendId, content);
&nbsp;//            return true;
&nbsp;//        } catch (Exception e) {
&nbsp;//            return false;
&nbsp;//        }
&nbsp;//    }
&nbsp;
&nbsp;//    @PostMapping(&quot;/invitation/accept&quot;)
&nbsp;//    public Response acceptInvitation(@RequestHeader(&quot;Authorization&quot;) String token, @RequestParam(&quot;message_id&quot;) long messageId) {
&nbsp;//        try {
&nbsp;//            long userId = JwtUtil.getIdByToken(token);
&nbsp;//            Student student = studentService.findStudentById(userId);
&nbsp;//            Message invitation = messageService.findMessageById(messageId);
&nbsp;//            Student friend = studentService.findStudentById(invitation.getFrom().getId());
&nbsp;//            Response response = handleInvitationError(invitation, student, friend, &quot;Accept&quot;);
&nbsp;//            if (response.isResult()) {
&nbsp;//                messageService.deleteMessageById(messageId);
&nbsp;//                List&lt;Student&gt; students = studentService.getStudentByTeamId(friend.getTeam().getId());
&nbsp;//                student.setTeam(friend.getTeam());
&nbsp;//                studentService.updateStudent(student);
&nbsp;//                for (Student s : students) {
&nbsp;//                    Message message = new Message();
&nbsp;//                    message.setFrom(student);
&nbsp;//                    message.setTo(s);
&nbsp;//                    message.setType(&quot;Notice&quot;);
&nbsp;//                    JSONObject jsonObject = new JSONObject();
&nbsp;//                    jsonObject.put(&quot;title&quot;, &quot;Invitation&quot;);
&nbsp;//                    jsonObject.put(&quot;content&quot;, &quot;Your team has a new member: &quot; + student.getName());
&nbsp;//                    message.setContent(jsonObject.toString());
&nbsp;//                    message.setTime(LocalDateTime.now());
&nbsp;//                    message.setRead(false);
&nbsp;//                    messageService.saveMessage(message);
&nbsp;//                }
&nbsp;//            }
&nbsp;//            return response;
&nbsp;//        } catch (Exception e) {
&nbsp;//            return new Response(new MyException(-10086, e.getMessage()));
&nbsp;//        }
&nbsp;//    }
&nbsp;
&nbsp;//    @PostMapping(&quot;/invitation/reject&quot;)
&nbsp;//    public Response rejectInvitation(@RequestHeader(&quot;Authorization&quot;) String token, @RequestParam(&quot;message_id&quot;) long messageId) {
&nbsp;//        try {
&nbsp;//            long userId = JwtUtil.getIdByToken(token);
&nbsp;//            Student student = studentService.findStudentById(userId);
&nbsp;//            Message invitation = messageService.findMessageById(messageId);
&nbsp;//            Student friend = studentService.findStudentById(invitation.getFrom().getId());
&nbsp;//            Response response = handleInvitationError(invitation, student, friend, &quot;Reject&quot;);
&nbsp;//            if (response.isResult()) {
&nbsp;//                messageService.deleteMessageById(messageId);
&nbsp;//            }
&nbsp;//            return response;
&nbsp;//        } catch (Exception e) {
&nbsp;//            return new Response(new MyException(-10086, e.getMessage()));
&nbsp;//        }
&nbsp;//    }
&nbsp;
&nbsp;    /**
&nbsp;     * 获取评论
&nbsp;     * @param token 用户token
&nbsp;     * @return 评论列表
&nbsp;     */
&nbsp;    @GetMapping(&quot;/comment&quot;)
&nbsp;    public List&lt;MessageDto&gt; getComment(@RequestHeader(&quot;Authorization&quot;) String token) {
<b class="nc">&nbsp;        long userId = JwtUtil.getIdByToken(token);</b>
<b class="nc">&nbsp;        List&lt;Message&gt; toMessages = messageService.findMessageByToUserIdAndType(userId, &quot;Comment&quot;);</b>
<b class="nc">&nbsp;        return toMessages.stream().map(this::constructMessageDto).toList();</b>
&nbsp;    }
&nbsp;
&nbsp;//    @GetMapping(&quot;/exchange&quot;)
&nbsp;//    public List&lt;Message&gt; getExchange(@RequestHeader(&quot;Authorization&quot;) String token) {
&nbsp;//        long userId = JwtUtil.getIdByToken(token);
&nbsp;//        List&lt;Message&gt; fromMessages = messageService.findMessageByFromIdAndType(userId, &quot;Exchange&quot;);
&nbsp;//        List&lt;Message&gt; toMessages = messageService.findMessageByToIdAndType(userId, &quot;Exchange&quot;);
&nbsp;//        fromMessages.addAll(toMessages);
&nbsp;//        return fromMessages;
&nbsp;//    }
&nbsp;
&nbsp;    /**
&nbsp;     * @param token 用户token
&nbsp;     * @param type 消息类型
&nbsp;     * @param id 好友id
&nbsp;     * @return 设为已读是否成功
&nbsp;     */
&nbsp;    @PostMapping(&quot;/read&quot;)
&nbsp;    public boolean readMessages(@RequestHeader(&quot;Authorization&quot;) String token, @RequestParam(&quot;messageType&quot;) String type, @RequestParam(value = &quot;userId&quot;, defaultValue = &quot;-1&quot;) long id) {
<b class="nc">&nbsp;        long userId = JwtUtil.getIdByToken(token);</b>
<b class="nc">&nbsp;        StringBuilder parsedType = new StringBuilder(type);</b>
<b class="nc">&nbsp;        parsedType.setCharAt(0, Character.toUpperCase(parsedType.charAt(0)));</b>
<b class="nc">&nbsp;        if (parsedType.toString().equalsIgnoreCase(&quot;Chat&quot;)) {</b>
<b class="nc">&nbsp;            if (id == -1) {</b>
<b class="nc">&nbsp;                return false;</b>
&nbsp;            }
<b class="nc">&nbsp;            List&lt;Message&gt; messages = messageService.findMessageByFromIdAndToUserIdAndType(id, userId, parsedType.toString());</b>
<b class="nc">&nbsp;            for (Message message : messages) {</b>
<b class="nc">&nbsp;                message.setRead(true);</b>
<b class="nc">&nbsp;                messageService.updateMessage(message);</b>
&nbsp;            }
&nbsp;        } else {
<b class="nc">&nbsp;            List&lt;Message&gt; messages = messageService.findMessageByToUserIdAndType(userId, parsedType.toString());</b>
<b class="nc">&nbsp;            for (Message message : messages) {</b>
<b class="nc">&nbsp;                message.setRead(true);</b>
<b class="nc">&nbsp;                messageService.updateMessage(message);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        return true;</b>
&nbsp;    }
&nbsp;//    public boolean readMessages(@RequestParam(&quot;id&quot;) long userId, @RequestParam(&quot;messageType&quot;) String type, @RequestParam(value = &quot;userId&quot;, defaultValue = &quot;-1&quot;) long id) {
&nbsp;//        StringBuilder parsedType = new StringBuilder(type);
&nbsp;//        parsedType.setCharAt(0, Character.toUpperCase(parsedType.charAt(0)));
&nbsp;//        if (parsedType.toString().equalsIgnoreCase(&quot;Chat&quot;)) {
&nbsp;//            if (id == -1) {
&nbsp;//                return false;
&nbsp;//            }
&nbsp;//            List&lt;Message&gt; messages = messageService.findMessageByFromIdAndToUserIdAndType(id, userId, parsedType.toString());
&nbsp;//            for (Message message : messages) {
&nbsp;//                message.setRead(true);
&nbsp;//                messageService.updateMessage(message);
&nbsp;//            }
&nbsp;//        } else {
&nbsp;//            List&lt;Message&gt; messages = messageService.findMessageByToUserIdAndType(userId, parsedType.toString());
&nbsp;//            for (Message message : messages) {
&nbsp;//                message.setRead(true);
&nbsp;//                messageService.updateMessage(message);
&nbsp;//            }
&nbsp;//        }
&nbsp;//        return true;
&nbsp;//    }
&nbsp;
&nbsp;    /**
&nbsp;     * @param token 用户token
&nbsp;     * @return 是否有未读消息
&nbsp;     */
&nbsp;    @GetMapping(&quot;/hasAnyUnread&quot;)
&nbsp;    public boolean hasAnyUnread(@RequestHeader(&quot;Authorization&quot;) String token) {
<b class="nc">&nbsp;        long userId = JwtUtil.getIdByToken(token);</b>
<b class="nc">&nbsp;        return !messageService.findMessageByToUserIdAndRead(userId, false).isEmpty();</b>
&nbsp;    }
&nbsp;//    public boolean hasAnyUnread(@RequestParam(&quot;id&quot;) long userId) {
&nbsp;//        return !messageService.findMessageByToUserIdAndRead(userId, false).isEmpty();
&nbsp;//    }
&nbsp;
&nbsp;    /**
&nbsp;     * @param token 用户token
&nbsp;     * @return 对应的消息类型是否有未读消息
&nbsp;     */
&nbsp;    @GetMapping(&quot;/hasUnread&quot;)
&nbsp;    public String hasUnread(@RequestHeader(&quot;Authorization&quot;) String token) {
<b class="nc">&nbsp;        long userId = JwtUtil.getIdByToken(token);</b>
<b class="nc">&nbsp;        String[] types = {&quot;Chat&quot;, &quot;Notice&quot;, &quot;Comment&quot;};</b>
<b class="nc">&nbsp;        JSONObject jsonObject = new JSONObject();</b>
<b class="nc">&nbsp;        for (String type : types) {</b>
<b class="nc">&nbsp;            jsonObject.put(type.toLowerCase(), !messageService.findMessageByToUserIdAndTypeAndRead(userId, type, false).isEmpty());</b>
&nbsp;        }
<b class="nc">&nbsp;        return jsonObject.toString();</b>
&nbsp;    }
&nbsp;//    public String hasUnread(@RequestParam(&quot;id&quot;) long userId) {
&nbsp;//        String[] types = {&quot;Chat&quot;, &quot;Notice&quot;, &quot;Comment&quot;};
&nbsp;//        JSONObject jsonObject = new JSONObject();
&nbsp;//        for (String type : types) {
&nbsp;//            jsonObject.put(type.toLowerCase(), !messageService.findMessageByToUserIdAndTypeAndRead(userId, type, false).isEmpty());
&nbsp;//        }
&nbsp;//        return jsonObject.toString();
&nbsp;//    }
&nbsp;
&nbsp;//    @PostMapping(&quot;/exchange/accept&quot;)
&nbsp;//    public Response acceptExchange(@RequestHeader(&quot;Authorization&quot;) String token, @RequestParam(&quot;message_id&quot;) long messageId){
&nbsp;//        long userId = JwtUtil.getIdByToken(token);
&nbsp;//        Student student = studentService.findStudentById(userId);
&nbsp;//        Message exchange = messageService.findMessageById(messageId);
&nbsp;//        Student friend = studentService.findStudentById(exchange.getFrom().getId());
&nbsp;//        Response response = handleExchangeError(exchange, student, friend, &quot;Accept&quot;);
&nbsp;//        if (response.isResult()) {
&nbsp;//            messageService.deleteMessageById(messageId);
&nbsp;//            List&lt;Student&gt; students1 = studentService.getStudentByTeamId(student.getTeam().getId());
&nbsp;//            List&lt;Student&gt; students2 = studentService.getStudentByTeamId(friend.getTeam().getId());
&nbsp;//            Room oldRoom = student.getTeam().getRoom();
&nbsp;//            Room newRoom = friend.getTeam().getRoom();
&nbsp;//            friend.getTeam().setRoom(null);
&nbsp;//            studentTeamService.updateStudentTeam(friend.getTeam());
&nbsp;//            student.getTeam().setRoom(newRoom);
&nbsp;//            friend.getTeam().setRoom(oldRoom);
&nbsp;//            studentTeamService.updateStudentTeam(student.getTeam());
&nbsp;//            studentTeamService.updateStudentTeam(friend.getTeam());
&nbsp;//            LocalDateTime now = LocalDateTime.now();
&nbsp;//            for (Student s: students1) {
&nbsp;//                Message message = new Message();
&nbsp;//                message.setFrom(friend);
&nbsp;//                message.setTo(s);
&nbsp;//                message.setType(&quot;Notice&quot;);
&nbsp;//                JSONObject jsonObject = new JSONObject();
&nbsp;//                jsonObject.put(&quot;title&quot;, &quot;Exchange&quot;);
&nbsp;//                jsonObject.put(&quot;content&quot;, &quot;Your room exchange to &quot; + getRoomName(newRoom));
&nbsp;//                message.setContent(jsonObject.toString());
&nbsp;//                message.setRead(false);
&nbsp;//                message.setTime(now);
&nbsp;//                messageService.saveMessage(message);
&nbsp;//            }
&nbsp;//            for (Student s: students2) {
&nbsp;//                Message message = new Message();
&nbsp;//                message.setFrom(student);
&nbsp;//                message.setTo(s);
&nbsp;//                message.setType(&quot;Notice&quot;);
&nbsp;//                JSONObject jsonObject = new JSONObject();
&nbsp;//                jsonObject.put(&quot;title&quot;, &quot;Exchange&quot;);
&nbsp;//                jsonObject.put(&quot;content&quot;, &quot;Your room exchange to &quot; + getRoomName(newRoom));
&nbsp;//                message.setContent(jsonObject.toString());
&nbsp;//                message.setRead(false);
&nbsp;//                message.setTime(now);
&nbsp;//                messageService.saveMessage(message);
&nbsp;//            }
&nbsp;//        }
&nbsp;//        return response;
&nbsp;//    }
&nbsp;
&nbsp;//    @PostMapping(&quot;/exchange/reject&quot;)
&nbsp;//    public Response rejectExchange(@RequestHeader(&quot;Authorization&quot;) String token, @RequestParam(&quot;message_id&quot;) long messageId){
&nbsp;//        try {
&nbsp;//            long userId = JwtUtil.getIdByToken(token);
&nbsp;//            Student student = studentService.findStudentById(userId);
&nbsp;//            Message exchange = messageService.findMessageById(messageId);
&nbsp;//            Student friend = studentService.findStudentById(exchange.getFrom().getId());
&nbsp;//            Response response = handleExchangeError(exchange, student, friend, &quot;Reject&quot;);
&nbsp;//            if (response.isResult()) {
&nbsp;//                messageService.deleteMessageById(messageId);
&nbsp;//            }
&nbsp;//            return response;
&nbsp;//        } catch (Exception e) {
&nbsp;//            return new Response(new MyException(-10086, e.getMessage()));
&nbsp;//        }
&nbsp;//    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-06-03 14:18</div>
</div>
</body>
</html>
