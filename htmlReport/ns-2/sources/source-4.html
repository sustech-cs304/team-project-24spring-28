


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=GBK"> 
  <title>Coverage Report > EventApp</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">org.example.backend.app</a>
</div>

<h1>Coverage Summary for Class: EventApp (org.example.backend.app)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">EventApp</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    92.3%
  </span>
  <span class="absValue">
    (12/13)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    52.2%
  </span>
  <span class="absValue">
    (24/46)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    76.1%
  </span>
  <span class="absValue">
    (102/134)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package org.example.backend.app;
&nbsp;
&nbsp;import jakarta.servlet.http.HttpServletResponse;
&nbsp;import org.apache.poi.xssf.usermodel.XSSFRow;
&nbsp;import org.apache.poi.xssf.usermodel.XSSFSheet;
&nbsp;import org.apache.poi.xssf.usermodel.XSSFWorkbook;
&nbsp;import org.example.backend.config.MyException;
&nbsp;import org.example.backend.domain.*;
&nbsp;import org.example.backend.dto.DefinedFormDto;
&nbsp;import org.example.backend.dto.EventBriefDto;
&nbsp;import org.example.backend.dto.EventDto;
&nbsp;import org.example.backend.dto.EventPostDto;
&nbsp;import org.example.backend.service.AbstractEnrollmentService;
&nbsp;import org.example.backend.service.AbstractUserService;
&nbsp;import org.example.backend.service.EventService;
&nbsp;import org.example.backend.util.JwtUtil;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.web.bind.annotation.*;
&nbsp;
&nbsp;
&nbsp;import java.io.IOException;
&nbsp;import java.time.LocalDateTime;
&nbsp;import java.time.format.DateTimeFormatter;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.List;
&nbsp;
&nbsp;/**
&nbsp; * 该类用于处理活动相关的请求
&nbsp; * @author wangyr
&nbsp; * @version 1.0
&nbsp; */
&nbsp;@RestController
&nbsp;@RequestMapping(&quot;/event&quot;)
<b class="fc">&nbsp;public class EventApp {</b>
&nbsp;    @Autowired
&nbsp;    EventService eventService;
&nbsp;    @Autowired
&nbsp;    AbstractEnrollmentService abstractEnrollmentService;
&nbsp;
&nbsp;    /**
&nbsp;     * @param token 用户token
&nbsp;     * @param eventPostDto 活动信息
&nbsp;     * @return 是否创建成功
&nbsp;     */
&nbsp;    @PostMapping(&quot;/create&quot;)
&nbsp;//    public boolean releaseEvent(@RequestHeader(&quot;Authorization&quot;) String token, @RequestParam String title, @RequestParam String name, @RequestParam String enrollmentType, @RequestParam String applyStartTime, @RequestParam String applyEndTime, @RequestParam String startTime, @RequestParam String endTime, @RequestParam String imageUrl, @RequestParam String introduction, @RequestParam String mdText, @RequestParam(required = false) long limitCount, @RequestParam(required = false) List&lt;DefinedFormDto&gt; definedForm) {
&nbsp;    public boolean releaseEvent(@RequestHeader(&quot;Authorization&quot;) String token, @RequestBody EventPostDto eventPostDto) {
<b class="fc">&nbsp;        User user = (User) JwtUtil.verifyToken(token);</b>
<b class="pc">&nbsp;        if (!user.getPermission().isCanCreate()) {</b>
<b class="nc">&nbsp;            throw new MyException(-1, &quot;Permission denied&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        Event event = new Event();</b>
<b class="fc">&nbsp;        event.setTitle(eventPostDto.getTitle());</b>
<b class="fc">&nbsp;        event.setName(eventPostDto.getName());</b>
<b class="fc">&nbsp;        event.setAuthor(user);</b>
<b class="fc">&nbsp;        event.setIntroduction(eventPostDto.getIntroduction());</b>
<b class="fc">&nbsp;        event.setPosterUrl(eventPostDto.getImageUrl());</b>
<b class="fc">&nbsp;        event.setText(eventPostDto.getMdText());</b>
<b class="fc">&nbsp;        event.setStartTime(LocalDateTime.parse(eventPostDto.getStartTime(), DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;)));</b>
<b class="fc">&nbsp;        event.setEndTime(LocalDateTime.parse(eventPostDto.getEndTime(), DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;)));</b>
<b class="pc">&nbsp;        switch (eventPostDto.getEnrollmentType()) {</b>
&nbsp;            case &quot;count&quot;:
<b class="nc">&nbsp;                CountEnrollment countEnrollment = new CountEnrollment();</b>
<b class="nc">&nbsp;                countEnrollment.setStartTime(LocalDateTime.parse(eventPostDto.getApplyStartTime(), DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;)));</b>
<b class="nc">&nbsp;                countEnrollment.setEndTime(LocalDateTime.parse(eventPostDto.getApplyEndTime(), DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;)));</b>
<b class="nc">&nbsp;                countEnrollment.setCapacity(eventPostDto.getLimitCount());</b>
<b class="nc">&nbsp;                countEnrollment.setEvent(event);</b>
<b class="nc">&nbsp;                event.setAbstractEnrollment(countEnrollment);</b>
&nbsp;                break;
&nbsp;            case &quot;form&quot;:
<b class="fc">&nbsp;                FormEnrollment formEnrollment = new FormEnrollment();</b>
<b class="fc">&nbsp;                formEnrollment.setStartTime(LocalDateTime.parse(eventPostDto.getApplyStartTime(), DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;)));</b>
<b class="fc">&nbsp;                formEnrollment.setEndTime(LocalDateTime.parse(eventPostDto.getApplyEndTime(), DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd HH:mm:ss&quot;)));</b>
<b class="fc">&nbsp;                formEnrollment.setDefinedFormEntries(eventPostDto.getDefinedForm().stream().map(DefinedFormDto::toDefinedFormEntry).toList());</b>
<b class="fc">&nbsp;                formEnrollment.setEvent(event);</b>
<b class="fc">&nbsp;                event.setAbstractEnrollment(formEnrollment);</b>
&nbsp;                break;
&nbsp;        }
<b class="fc">&nbsp;        return eventService.saveEvent(event);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @return 所有活动ID
&nbsp;     */
&nbsp;    @GetMapping(&quot;/all&quot;)
&nbsp;    public long[] getAllEvents() {
<b class="nc">&nbsp;        return eventService.findAllEvents().stream().mapToLong(Event::getId).toArray();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @param token 用户token
&nbsp;     * @param eventId 活动ID
&nbsp;     * @return 活动信息
&nbsp;     */
&nbsp;    @GetMapping(&quot;/detail&quot;)
&nbsp;    public EventDto getEvent(@RequestHeader(&quot;Authorization&quot;) String token, @RequestParam(&quot;id&quot;) long eventId) {
<b class="fc">&nbsp;        User user = (User) JwtUtil.verifyToken(token);</b>
<b class="fc">&nbsp;        Event event = eventService.findEventById(eventId);</b>
<b class="pc">&nbsp;        if (event == null) {</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
<b class="fc">&nbsp;        EventDto eventDto = new EventDto(event);</b>
<b class="fc">&nbsp;        eventDto.setLiked(user.getFavouriteEvents().contains(event));</b>
<b class="fc">&nbsp;        eventDto.setGrade(eventService.getScore(user.getId(), eventId));</b>
<b class="fc">&nbsp;        return eventDto;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @param eventId 活动ID
&nbsp;     * @return 活动简要信息
&nbsp;     */
&nbsp;    @GetMapping(&quot;/brief&quot;)
&nbsp;    public EventBriefDto getEventBrief(@RequestParam(&quot;id&quot;) long eventId) {
<b class="fc">&nbsp;        Event event = eventService.findEventById(eventId);</b>
<b class="pc">&nbsp;        if (event == null) {</b>
<b class="nc">&nbsp;            return null;</b>
&nbsp;        }
<b class="fc">&nbsp;        return new EventBriefDto(event);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @param token 用户token
&nbsp;     * @return 用户发布活动的简要信息
&nbsp;     */
&nbsp;    @GetMapping(&quot;/hold&quot;)
&nbsp;    public List&lt;EventBriefDto&gt; getEventByAuthorId(@RequestHeader(&quot;Authorization&quot;) String token) {
<b class="fc">&nbsp;        long authorId = JwtUtil.verifyToken(token).getId();</b>
<b class="fc">&nbsp;        return eventService.findEventByAuthorId(authorId).stream().map(EventBriefDto::new).toList();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @param token 用户token
&nbsp;     * @param eventId 活动ID
&nbsp;     * @param formValues 报名表单(可选)
&nbsp;     * @return 是否删除成功
&nbsp;     */
&nbsp;    @PostMapping(&quot;/apply&quot;)
&nbsp;    public boolean applyEvent(@RequestHeader(&quot;Authorization&quot;) String token, @RequestParam(&quot;id&quot;) long eventId, @RequestParam(value = &quot;formValues[]&quot;, required = false) List&lt;String&gt; formValues) {
<b class="fc">&nbsp;        User user = (User) JwtUtil.verifyToken(token);</b>
<b class="pc">&nbsp;        if (!user.getPermission().isCanEnroll()) {</b>
<b class="nc">&nbsp;            throw new MyException(-1, &quot;Permission denied&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        Event event = eventService.findEventById(eventId);</b>
<b class="fc">&nbsp;        EnrollForm enrollForm = new EnrollForm();</b>
<b class="fc">&nbsp;        AbstractEnrollment abstractEnrollment = event.getAbstractEnrollment();</b>
<b class="pc">&nbsp;        if (abstractEnrollment instanceof CountEnrollment countEnrollment) {</b>
<b class="nc">&nbsp;            if (countEnrollment.getCount() &gt;= countEnrollment.getCapacity()) {</b>
<b class="nc">&nbsp;                throw new MyException(-1, &quot;Capacity full&quot;);</b>
<b class="nc">&nbsp;            } else if (eventService.appliedByUser(user.getId(), eventId)) {</b>
<b class="nc">&nbsp;                throw new MyException(-1, &quot;Already applied&quot;);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                countEnrollment.setCount(countEnrollment.getCount() + 1);</b>
<b class="nc">&nbsp;                List&lt;User&gt; participants = countEnrollment.getParticipants();</b>
<b class="nc">&nbsp;                participants.add(user);</b>
&nbsp;            }
&nbsp;        }
<b class="pc">&nbsp;        if (abstractEnrollment instanceof FormEnrollment formEnrollment) {</b>
<b class="pc">&nbsp;            if (formValues.size() != formEnrollment.getDefinedFormEntries().size()) {</b>
<b class="nc">&nbsp;                throw new MyException(-1, &quot;Form values not match&quot;);</b>
&nbsp;            } else {
<b class="fc">&nbsp;                List&lt;User&gt; participants = formEnrollment.getParticipants();</b>
<b class="fc">&nbsp;                if (!eventService.appliedByUser(user.getId(), eventId)) {</b>
<b class="fc">&nbsp;                    participants.add(user);</b>
&nbsp;                }
<b class="fc">&nbsp;                enrollForm.setUser(user);</b>
<b class="fc">&nbsp;                enrollForm.setFormEnrollment((FormEnrollment) event.getAbstractEnrollment());</b>
<b class="fc">&nbsp;                enrollForm.setFormValues(formValues);</b>
<b class="fc">&nbsp;                eventService.saveEnrollForm(enrollForm);</b>
&nbsp;            }
&nbsp;        }
<b class="fc">&nbsp;        abstractEnrollmentService.updateAbstractEnrollment(abstractEnrollment);</b>
<b class="fc">&nbsp;        return true;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @param id 活动ID
&nbsp;     */
&nbsp;    @GetMapping(&quot;/getExcel&quot;)
&nbsp;    @ResponseBody
&nbsp;    public void getExcel(@RequestParam(&quot;id&quot;) long id, HttpServletResponse response) {
<b class="fc">&nbsp;        Event event = eventService.findEventById(id);</b>
<b class="fc">&nbsp;        AbstractEnrollment abstractEnrollment = event.getAbstractEnrollment();</b>
<b class="pc">&nbsp;        if (!(abstractEnrollment instanceof CountEnrollment) &amp;&amp; !(abstractEnrollment instanceof FormEnrollment)) {</b>
<b class="nc">&nbsp;            throw new MyException(0, &quot;Unsupported enrollment type&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        String fileName = &quot;participants.xlsx&quot;;</b>
<b class="fc">&nbsp;        try (XSSFWorkbook workbook = new XSSFWorkbook()) {</b>
<b class="fc">&nbsp;            XSSFSheet sheet = workbook.createSheet();</b>
<b class="fc">&nbsp;            List&lt;String&gt; headers = new ArrayList&lt;&gt;(List.of(&quot;Username&quot;, &quot;Name&quot;));</b>
<b class="fc">&nbsp;            int rowNum = 0;</b>
<b class="fc">&nbsp;            XSSFRow row = sheet.createRow(rowNum);</b>
<b class="pc">&nbsp;            if (abstractEnrollment instanceof FormEnrollment) {</b>
<b class="fc">&nbsp;                for (DefinedFormEntry definedFormEntry : ((FormEnrollment) abstractEnrollment).getDefinedFormEntries()) {</b>
<b class="fc">&nbsp;                    headers.add(definedFormEntry.getName());</b>
&nbsp;                }
<b class="fc">&nbsp;                for (int i = 0; i &lt; headers.size(); i++) {</b>
<b class="fc">&nbsp;                    row.createCell(i).setCellValue(headers.get(i));</b>
&nbsp;                }
<b class="fc">&nbsp;                List&lt;EnrollForm&gt; enrollForms = ((FormEnrollment) abstractEnrollment).getEnrollForms();</b>
<b class="fc">&nbsp;                for (EnrollForm enrollForm : enrollForms) {</b>
<b class="fc">&nbsp;                    row = sheet.createRow(++rowNum);</b>
<b class="fc">&nbsp;                    row.createCell(0).setCellValue(enrollForm.getUser().getUsername());</b>
<b class="fc">&nbsp;                    row.createCell(1).setCellValue(enrollForm.getUser().getName());</b>
<b class="fc">&nbsp;                    List&lt;String&gt; formValues = enrollForm.getFormValues();</b>
<b class="fc">&nbsp;                    for (int i = 0; i &lt; formValues.size(); i++) {</b>
<b class="fc">&nbsp;                        row.createCell(i + 2).setCellValue(formValues.get(i));</b>
&nbsp;                    }
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                for (int i = 0; i &lt; headers.size(); i++) {</b>
<b class="nc">&nbsp;                    row.createCell(i).setCellValue(headers.get(i));</b>
&nbsp;                }
<b class="nc">&nbsp;                List&lt;User&gt; participants = abstractEnrollment.getParticipants();</b>
<b class="nc">&nbsp;                for (User participant : participants) {</b>
<b class="nc">&nbsp;                    row = sheet.createRow(++rowNum);</b>
<b class="nc">&nbsp;                    row.createCell(0).setCellValue(participant.getUsername());</b>
<b class="nc">&nbsp;                    row.createCell(1).setCellValue(participant.getName());</b>
&nbsp;                }
&nbsp;            }
<b class="fc">&nbsp;            response.setContentType(&quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;);</b>
<b class="fc">&nbsp;            response.setHeader(&quot;Content-Disposition&quot;, &quot;attachment; filename=&quot; + fileName);</b>
<b class="fc">&nbsp;            workbook.write(response.getOutputStream());</b>
<b class="fc">&nbsp;        } catch (IOException e) {</b>
<b class="nc">&nbsp;            throw new RuntimeException(e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @param token 用户token
&nbsp;     * @param eventId 活动ID
&nbsp;     * @return 收藏活动是否成功
&nbsp;     */
&nbsp;    @PostMapping(&quot;/favor&quot;)
&nbsp;    public boolean favorEvent(@RequestHeader(&quot;Authorization&quot;) String token, @RequestParam(&quot;id&quot;) long eventId) {
<b class="fc">&nbsp;        User user = (User) JwtUtil.verifyToken(token);</b>
<b class="fc">&nbsp;        Event event = eventService.findEventById(eventId);</b>
<b class="fc">&nbsp;        List&lt;Event&gt; favoriteEvents = user.getFavouriteEvents();</b>
<b class="pc">&nbsp;        if (!favoriteEvents.contains(event)) {</b>
<b class="fc">&nbsp;            favoriteEvents.add(event);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            throw new MyException(-1, &quot;Event already favored&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        user.setFavouriteEvents(favoriteEvents);</b>
<b class="fc">&nbsp;        return eventService.updateEvent(event);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @param token 用户token
&nbsp;     * @param eventId 活动ID
&nbsp;     * @return 取消收藏活动是否成功
&nbsp;     */
&nbsp;    @PostMapping(&quot;/unfavor&quot;)
&nbsp;    public boolean unfavorEvent(@RequestHeader(&quot;Authorization&quot;) String token, @RequestParam(&quot;id&quot;) long eventId) {
<b class="fc">&nbsp;        User user = (User) JwtUtil.verifyToken(token);</b>
<b class="fc">&nbsp;        Event event = eventService.findEventById(eventId);</b>
<b class="fc">&nbsp;        List&lt;Event&gt; favoriteEvents = user.getFavouriteEvents();</b>
<b class="pc">&nbsp;        if (favoriteEvents.contains(event)) {</b>
<b class="fc">&nbsp;            favoriteEvents.remove(event);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            throw new MyException(-1, &quot;Event not favored&quot;);</b>
&nbsp;        }
<b class="fc">&nbsp;        user.setFavouriteEvents(favoriteEvents);</b>
<b class="fc">&nbsp;        return eventService.updateEvent(event);</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @param token 用户token
&nbsp;     * @param eventId 活动ID
&nbsp;     * @param grade 评分
&nbsp;     * @return 评分是否成功
&nbsp;     */
&nbsp;    @PostMapping(&quot;/grade&quot;)
&nbsp;    public boolean gradeEvent(@RequestHeader(&quot;Authorization&quot;) String token, @RequestParam(&quot;id&quot;) long eventId, @RequestParam(&quot;grade&quot;) int grade) {
<b class="fc">&nbsp;        User user = (User) JwtUtil.verifyToken(token);</b>
<b class="fc">&nbsp;        Event event = eventService.findEventById(eventId);</b>
<b class="fc">&nbsp;        List&lt;Event&gt; scoredEvents = user.getScoredEvents();</b>
<b class="pc">&nbsp;        if (!scoredEvents.contains(event)) {</b>
<b class="fc">&nbsp;            event.setScore((event.getScore() * event.getScoreCount() + grade) / (event.getScoreCount() + 1));</b>
<b class="fc">&nbsp;            event.setScoreCount(event.getScoreCount() + 1);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            long previousScore = eventService.getScore(user.getId(), eventId);</b>
<b class="nc">&nbsp;            event.setScore((event.getScore() * event.getScoreCount() - previousScore + grade) / event.getScoreCount());</b>
&nbsp;        }
<b class="fc">&nbsp;        eventService.saveScore(user.getId(), eventId, grade);</b>
<b class="fc">&nbsp;        eventService.updateEvent(event);</b>
<b class="fc">&nbsp;        return true;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @param token 用户token
&nbsp;     * @return 用户已报名的活动ID
&nbsp;     */
&nbsp;    @GetMapping(&quot;/applied&quot;)
&nbsp;    public long[] getAppliedEvents(@RequestHeader(&quot;Authorization&quot;) String token) {
<b class="fc">&nbsp;        User user = (User) JwtUtil.verifyToken(token);</b>
<b class="fc">&nbsp;        return user.getEnrollments().stream().mapToLong(enrollment -&gt; enrollment.getEvent().getId()).toArray();</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * @param token 用户token
&nbsp;     * @return 用户收藏的活动ID
&nbsp;     */
&nbsp;    @GetMapping(&quot;favored&quot;)
&nbsp;    public long[] getFavoredEvents(@RequestHeader(&quot;Authorization&quot;) String token) {
<b class="fc">&nbsp;        User user = (User) JwtUtil.verifyToken(token);</b>
<b class="fc">&nbsp;        return user.getFavouriteEvents().stream().mapToLong(Event::getId).toArray();</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-06-03 14:18</div>
</div>
</body>
</html>
